<!DOCTYPE HTML>
<meta charset=utf-8>
<title>PerformanceObservers: disconnect</title>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<h1>PerformanceObservers: disconnect</h1>
<div id="log"></div>
<script>
  var disconnectTest = async_test("disconnected callbacks must not be invoked");
  var disconnect_observer;
  function disconnectPO(entryList, obs) {
    assert_unreached("This callback must not be invoked");
  }
  disconnectTest.step(function() {
    disconnect_observer = new PerformanceObserver(disconnectPO);
    disconnect_observer.observe({entryTypes: ["mark", "measure", "navigation"]});
  });
  disconnectTest.step(function() {
    disconnect_observer.disconnect();
    if (performance.mark !== undefined) performance.mark("mark1");
    if (performance.measure !== undefined) performance.measure("measure1");
  });
  disconnectTest.step_timeout(function () {
    disconnectTest.done();
  }, 2000);

  test(function () {
    var obs = new PerformanceObserver(function () { return true; });
    obs.disconnect();
    obs.disconnect();
  }, "disconnecting an unconnected observer is a no-op");


  var markTest = async_test("An observer disconnected after a mark must receive the mark");
  var mark_observer;
  var gotMark = false;
  function markPO(entryList, obs) {
    markTest.step(function() {
      checkEntries(entryList.getEntries(),
        [{ entryType: "mark", name: "mark1"}]);
      markTest.done();
    });
  }
  markTest.step(function() {
    mark_observer = new PerformanceObserver(markPO);
    mark_observer.observe({entryTypes: ["mark"]});
    performance.mark("mark1");
    mark_observer.disconnect();
    performance.mark("mark2");
  });
</script>
